version: '3.8'

services:
  eventstore:
    image: eventstore/eventstore:21.6.0-buster-slim
    environment:
    - EVENTSTORE_START_STANDARD_PROJECTIONS=True
    - EVENTSTORE_RUN_PROJECTIONS=All
    volumes:
    - spear_eventstore:/var/lib/eventstore
    - ./eventstoredb:/etc/eventstore:ro
    # command: "--insecure --run-projections=All"
    ports:
    - 2113:2113

  app:
    image: elixir:1.12.1
    depends_on:
    - eventstore
    environment:
    - 'ERL_AFLAGS=-kernel shell_history enabled'
    - EVENTSTORE_HOST=eventstore
    - EVENTSTORE_VERSION=21.6.0
    volumes:
    - ./:/app
    working_dir: /app
    command: bash -c "mix local.rebar --force && mix local.hex --force && tail -f /dev/null"

volumes:
  spear_eventstore:
